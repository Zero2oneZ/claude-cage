#!/usr/bin/env bash
# claude-cage â€” Dockerized sandbox for Claude CLI & Claude Desktop
# Usage: claude-cage <command> [options]
set -euo pipefail

CAGE_VERSION="0.2.0"
CAGE_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
CAGE_DATA_DIR="${CAGE_DATA_DIR:-$HOME/.local/share/claude-cage}"

# Source libraries
source "$CAGE_ROOT/lib/config.sh"
source "$CAGE_ROOT/lib/sandbox.sh"
source "$CAGE_ROOT/lib/docker.sh"
source "$CAGE_ROOT/lib/session.sh"
source "$CAGE_ROOT/lib/tui.sh"
source "$CAGE_ROOT/lib/gui.sh"
source "$CAGE_ROOT/lib/tree.sh"
source "$CAGE_ROOT/lib/architect.sh"
source "$CAGE_ROOT/lib/docs.sh"
source "$CAGE_ROOT/lib/integrations.sh"
source "$CAGE_ROOT/lib/mongodb.sh"
source "$CAGE_ROOT/lib/memory.sh"
source "$CAGE_ROOT/lib/observability.sh"
source "$CAGE_ROOT/lib/lifecycle.sh"
source "$CAGE_ROOT/lib/cli.sh"

main() {
    # Initialize subsystems
    mongo_init
    memory_init
    local command="${1:-help}"
    shift || true

    case "$command" in
        start)      cmd_start "$@" ;;
        stop)       cmd_stop "$@" ;;
        shell)      cmd_shell "$@" ;;
        status)     cmd_status "$@" ;;
        logs)       cmd_logs "$@" ;;
        list)       cmd_list "$@" ;;
        destroy)    cmd_destroy "$@" ;;
        build)      cmd_build "$@" ;;
        config)     cmd_config "$@" ;;
        init)       cmd_init "$@" ;;
        tree)       cmd_tree "$@" ;;
        ptc)        cmd_ptc "$@" ;;
        train)      cmd_train "$@" ;;
        design)     cmd_design "$@" ;;
        docs)       cmd_docs "$@" ;;
        ipfs)       cmd_ipfs "$@" ;;
        vsearch)    cmd_vsearch "$@" ;;
        porkbun)    cmd_porkbun "$@" ;;
        icons)      cmd_icons "$@" ;;
        fork|federation) cmd_fork "$@" ;;
        hf)         cmd_hf "$@" ;;
        gui|ui|tui) gui_main "$@" ;;
        web|dashboard) cmd_web "$@" ;;
        observe|obs|metrics) obs_dashboard "$@" ;;
        health)     obs_health "${1:-}" ;;
        memory)     memory_list "$@" ;;
        gc)         cmd_gc "$@" ;;
        reap)       cmd_reap "$@" ;;
        projects)   cmd_projects "$@" ;;
        version)    echo "claude-cage $CAGE_VERSION" ;;
        help|-h|--help) cmd_help "$@" ;;
        *)
            echo "Error: unknown command '$command'" >&2
            echo "Run 'claude-cage help' for usage." >&2
            exit 1
            ;;
    esac
}

main "$@"
