{
  "_meta": {
    "title": "claude-cage Root Tree",
    "description": "claude-cage IS root. Every project is a branch. Every trace flows back. The tree of trees.",
    "schema": "universal-node.schema.json",
    "version": "3.1.0"
  },
  "nodes": [
    {
      "id": "root:cage",
      "name": "claude-cage",
      "scale": "executive",
      "parent": null,
      "children": [
        "dept:runtime",
        "dept:security",
        "dept:sessions",
        "dept:config",
        "dept:observe",
        "dept:web",
        "dept:tree",
        "dept:ptc",
        "dept:training",
        "dept:architect",
        "dept:integrations",
        "project:gentlyos"
      ],
      "inputs": [
        {"name": "intent", "type": "task", "from": null},
        {"name": "cli_command", "type": "task", "from": null},
        {"name": "api_request", "type": "task", "from": null},
        {"name": "child_result", "type": "result", "from": null}
      ],
      "outputs": [
        {"name": "session", "type": "artifact", "to": null},
        {"name": "status", "type": "signal", "to": null},
        {"name": "training_data", "type": "artifact", "to": null},
        {"name": "child_tree", "type": "artifact", "to": null}
      ],
      "rules": [
        {"name": "dispatch", "condition": "command received", "action": "pass"},
        {"name": "safety_check", "condition": "destructive action", "action": "escalate"},
        {"name": "final_authority", "condition": "risk >= 9", "action": "block"}
      ],
      "escalation": {"target": null, "threshold": 10, "cascade": []},
      "metadata": {
        "project": "claude-cage",
        "entrypoint": "bin/claude-cage",
        "crates_owned": ["ALL"],
        "role": "Root of all trees. Every project is a branch. Every trace flows back."
      }
    },

    {
      "id": "dept:runtime",
      "name": "Container Runtime",
      "scale": "department",
      "parent": "root:cage",
      "children": ["capt:docker", "capt:compose", "capt:images"],
      "inputs": [
        {"name": "run_request", "type": "task", "from": "exec:cage"},
        {"name": "stop_request", "type": "task", "from": "exec:cage"}
      ],
      "outputs": [
        {"name": "container", "type": "artifact", "to": null},
        {"name": "lifecycle_event", "type": "signal", "to": "dept:observe"}
      ],
      "rules": [
        {"name": "image_required", "condition": "image not built", "action": "block"},
        {"name": "api_key_warn", "condition": "no api key and not max user", "action": "log"}
      ],
      "escalation": {"target": "root:cage", "threshold": 6, "cascade": ["root:cage"]},
      "metadata": {
        "crates_owned": ["docker", "compose"],
        "files": ["lib/docker.sh", "docker/cli/Dockerfile", "docker/desktop/Dockerfile", "docker-compose.yml"]
      }
    },
    {
      "id": "capt:docker",
      "name": "Docker Lifecycle",
      "scale": "captain",
      "parent": "dept:runtime",
      "children": [],
      "inputs": [
        {"name": "run_params", "type": "task", "from": "dept:runtime"}
      ],
      "outputs": [
        {"name": "container_id", "type": "artifact", "to": "dept:runtime"}
      ],
      "rules": [
        {"name": "label_all", "condition": "container created", "action": "pass"},
        {"name": "force_guard", "condition": "force destroy without confirm", "action": "escalate"}
      ],
      "escalation": {"target": "dept:runtime", "threshold": 4, "cascade": ["dept:runtime", "exec:cage"]},
      "metadata": {
        "crates_owned": ["docker"],
        "files": ["lib/docker.sh"],
        "functions": ["docker_run_session", "docker_stop_session", "docker_destroy_session", "docker_exec_session"]
      }
    },
    {
      "id": "capt:compose",
      "name": "Compose Services",
      "scale": "captain",
      "parent": "dept:runtime",
      "children": [],
      "inputs": [
        {"name": "service_request", "type": "task", "from": "dept:runtime"}
      ],
      "outputs": [
        {"name": "service_stack", "type": "artifact", "to": "dept:runtime"}
      ],
      "rules": [
        {"name": "common_anchor", "condition": "security baseline applies", "action": "pass"}
      ],
      "escalation": {"target": "dept:runtime", "threshold": 4, "cascade": ["dept:runtime"]},
      "metadata": {
        "crates_owned": ["compose"],
        "files": ["docker-compose.yml"],
        "services": ["cli", "desktop", "cli-isolated"]
      }
    },
    {
      "id": "capt:images",
      "name": "Image Builder",
      "scale": "captain",
      "parent": "dept:runtime",
      "children": [],
      "inputs": [
        {"name": "build_target", "type": "task", "from": "dept:runtime"}
      ],
      "outputs": [
        {"name": "image", "type": "artifact", "to": "dept:runtime"}
      ],
      "rules": [
        {"name": "dockerfile_valid", "condition": "syntax error", "action": "block"}
      ],
      "escalation": {"target": "dept:runtime", "threshold": 3, "cascade": ["dept:runtime"]},
      "metadata": {
        "crates_owned": ["images"],
        "files": ["docker/cli/Dockerfile", "docker/desktop/Dockerfile", "docker/desktop/entrypoint-desktop.sh"]
      }
    },

    {
      "id": "dept:security",
      "name": "Security",
      "scale": "department",
      "parent": "root:cage",
      "children": ["capt:sandbox", "capt:seccomp", "capt:apparmor", "capt:network"],
      "inputs": [
        {"name": "policy_request", "type": "task", "from": "exec:cage"}
      ],
      "outputs": [
        {"name": "security_flags", "type": "artifact", "to": "dept:runtime"},
        {"name": "audit_report", "type": "artifact", "to": "root:human"}
      ],
      "rules": [
        {"name": "defense_in_depth", "condition": "layer missing", "action": "block"},
        {"name": "no_escalation", "condition": "no-new-privileges violated", "action": "block"}
      ],
      "escalation": {"target": "root:cage", "threshold": 5, "cascade": ["root:cage"]},
      "metadata": {
        "sephira_mapping": "Daath",
        "crates_owned": ["sandbox", "seccomp", "apparmor", "network-filter"],
        "files": ["lib/sandbox.sh", "security/seccomp-default.json", "security/apparmor-profile"]
      }
    },
    {
      "id": "capt:sandbox",
      "name": "Sandbox Flags",
      "scale": "captain",
      "parent": "dept:security",
      "children": [],
      "inputs": [
        {"name": "policy_params", "type": "task", "from": "dept:security"}
      ],
      "outputs": [
        {"name": "docker_flags", "type": "artifact", "to": "dept:security"}
      ],
      "rules": [
        {"name": "readonly_root", "condition": "always", "action": "pass"},
        {"name": "cap_drop_all", "condition": "always", "action": "pass"},
        {"name": "resource_limits", "condition": "always", "action": "pass"}
      ],
      "escalation": {"target": "dept:security", "threshold": 3, "cascade": ["dept:security"]},
      "metadata": {
        "crates_owned": ["sandbox"],
        "files": ["lib/sandbox.sh"],
        "functions": ["sandbox_build_flags", "sandbox_verify"]
      }
    },
    {
      "id": "capt:seccomp",
      "name": "Seccomp Profile",
      "scale": "captain",
      "parent": "dept:security",
      "children": [],
      "inputs": [
        {"name": "syscall_policy", "type": "config", "from": "dept:security"}
      ],
      "outputs": [
        {"name": "seccomp_json", "type": "artifact", "to": "capt:sandbox"}
      ],
      "rules": [
        {"name": "allowlist_only", "condition": "syscall not in list", "action": "block"}
      ],
      "escalation": {"target": "dept:security", "threshold": 3, "cascade": ["dept:security"]},
      "metadata": {
        "crates_owned": ["seccomp"],
        "files": ["security/seccomp-default.json"],
        "syscall_count": 147
      }
    },
    {
      "id": "capt:apparmor",
      "name": "AppArmor Profile",
      "scale": "captain",
      "parent": "dept:security",
      "children": [],
      "inputs": [
        {"name": "access_policy", "type": "config", "from": "dept:security"}
      ],
      "outputs": [
        {"name": "apparmor_profile", "type": "artifact", "to": "capt:sandbox"}
      ],
      "rules": [
        {"name": "deny_mount", "condition": "mount attempt", "action": "block"},
        {"name": "deny_ptrace", "condition": "ptrace attempt", "action": "block"},
        {"name": "deny_raw_net", "condition": "raw network access", "action": "block"}
      ],
      "escalation": {"target": "dept:security", "threshold": 3, "cascade": ["dept:security"]},
      "metadata": {
        "crates_owned": ["apparmor"],
        "files": ["security/apparmor-profile"]
      }
    },
    {
      "id": "capt:network",
      "name": "Network Filter",
      "scale": "captain",
      "parent": "dept:security",
      "children": [],
      "inputs": [
        {"name": "allowed_hosts", "type": "config", "from": "dept:security"}
      ],
      "outputs": [
        {"name": "iptables_rules", "type": "artifact", "to": "dept:runtime"}
      ],
      "rules": [
        {"name": "allowlist_only", "condition": "host not in allowed_hosts", "action": "block"},
        {"name": "icc_disabled", "condition": "inter-container comms", "action": "block"}
      ],
      "escalation": {"target": "dept:security", "threshold": 4, "cascade": ["dept:security"]},
      "metadata": {
        "crates_owned": ["network-filter"],
        "files": ["lib/sandbox.sh"],
        "functions": ["sandbox_apply_network_filter"],
        "default_hosts": ["api.anthropic.com", "cdn.anthropic.com"]
      }
    },

    {
      "id": "dept:sessions",
      "name": "Session Management",
      "scale": "department",
      "parent": "root:cage",
      "children": ["capt:lifecycle", "capt:memory"],
      "inputs": [
        {"name": "session_command", "type": "task", "from": "exec:cage"}
      ],
      "outputs": [
        {"name": "session_metadata", "type": "artifact", "to": null},
        {"name": "session_event", "type": "signal", "to": "dept:observe"}
      ],
      "rules": [
        {"name": "unique_names", "condition": "name collision", "action": "block"}
      ],
      "escalation": {"target": "root:cage", "threshold": 5, "cascade": ["root:cage"]},
      "metadata": {
        "crates_owned": ["session", "memory"],
        "files": ["lib/session.sh", "lib/memory.sh"]
      }
    },
    {
      "id": "capt:lifecycle",
      "name": "Session Lifecycle",
      "scale": "captain",
      "parent": "dept:sessions",
      "children": [],
      "inputs": [
        {"name": "create_params", "type": "task", "from": "dept:sessions"}
      ],
      "outputs": [
        {"name": "session_record", "type": "artifact", "to": "dept:sessions"}
      ],
      "rules": [
        {"name": "name_format", "condition": "name generated", "action": "pass"}
      ],
      "escalation": {"target": "dept:sessions", "threshold": 3, "cascade": ["dept:sessions"]},
      "metadata": {
        "crates_owned": ["session"],
        "files": ["lib/session.sh"],
        "name_pattern": "adjective-noun-hex4"
      }
    },
    {
      "id": "capt:memory",
      "name": "Session Memory",
      "scale": "captain",
      "parent": "dept:sessions",
      "children": [],
      "inputs": [
        {"name": "context", "type": "data", "from": "dept:sessions"}
      ],
      "outputs": [
        {"name": "compacted_memory", "type": "artifact", "to": "dept:sessions"}
      ],
      "rules": [
        {"name": "ttl_30d", "condition": "memory older than 30 days", "action": "transform"}
      ],
      "escalation": {"target": "dept:sessions", "threshold": 3, "cascade": ["dept:sessions"]},
      "metadata": {
        "crates_owned": ["memory"],
        "files": ["lib/memory.sh"]
      }
    },

    {
      "id": "dept:config",
      "name": "Configuration",
      "scale": "department",
      "parent": "root:cage",
      "children": ["capt:yaml", "capt:cli-parse"],
      "inputs": [
        {"name": "config_path", "type": "config", "from": "exec:cage"}
      ],
      "outputs": [
        {"name": "CAGE_CFG", "type": "data", "to": "exec:cage"}
      ],
      "rules": [
        {"name": "default_merge", "condition": "user override exists", "action": "transform"},
        {"name": "validate", "condition": "required keys missing", "action": "block"}
      ],
      "escalation": {"target": "root:cage", "threshold": 4, "cascade": ["root:cage"]},
      "metadata": {
        "crates_owned": ["config"],
        "files": ["lib/config.sh", "config/default.yaml"]
      }
    },
    {
      "id": "capt:yaml",
      "name": "YAML Parser",
      "scale": "captain",
      "parent": "dept:config",
      "children": [],
      "inputs": [
        {"name": "yaml_file", "type": "data", "from": "dept:config"}
      ],
      "outputs": [
        {"name": "kv_pairs", "type": "data", "to": "dept:config"}
      ],
      "rules": [
        {"name": "flat_only", "condition": "nested structure", "action": "block"}
      ],
      "escalation": {"target": "dept:config", "threshold": 2, "cascade": ["dept:config"]},
      "metadata": {
        "crates_owned": ["config"],
        "files": ["lib/config.sh"],
        "limitation": "flat key:value only, no nested structures"
      }
    },
    {
      "id": "capt:cli-parse",
      "name": "CLI Parser",
      "scale": "captain",
      "parent": "dept:config",
      "children": [],
      "inputs": [
        {"name": "argv", "type": "data", "from": "exec:cage"}
      ],
      "outputs": [
        {"name": "parsed_args", "type": "data", "to": "dept:config"}
      ],
      "rules": [
        {"name": "validate_mode", "condition": "mode not cli|desktop", "action": "block"},
        {"name": "validate_network", "condition": "network not none|host|filtered", "action": "block"}
      ],
      "escalation": {"target": "dept:config", "threshold": 2, "cascade": ["dept:config"]},
      "metadata": {
        "crates_owned": ["cli"],
        "files": ["lib/cli.sh"],
        "functions": ["cmd_start", "cmd_stop", "cmd_shell", "cmd_build", "cmd_config"]
      }
    },

    {
      "id": "dept:observe",
      "name": "Observability",
      "scale": "department",
      "parent": "root:cage",
      "children": ["capt:metrics", "capt:mongodb"],
      "inputs": [
        {"name": "events", "type": "signal", "from": "dept:runtime"},
        {"name": "events", "type": "signal", "from": "dept:sessions"}
      ],
      "outputs": [
        {"name": "dashboard", "type": "artifact", "to": "root:human"},
        {"name": "stored_event", "type": "artifact", "to": null}
      ],
      "rules": [
        {"name": "fire_and_forget", "condition": "event received", "action": "log"},
        {"name": "never_block", "condition": "storage failure", "action": "pass"}
      ],
      "escalation": {"target": "root:cage", "threshold": 7, "cascade": ["root:cage"]},
      "metadata": {
        "crates_owned": ["observability", "mongodb"],
        "files": ["lib/observability.sh", "lib/mongodb.sh", "mongodb/store.js"]
      }
    },
    {
      "id": "capt:metrics",
      "name": "Container Metrics",
      "scale": "captain",
      "parent": "dept:observe",
      "children": [],
      "inputs": [
        {"name": "container_stats", "type": "data", "from": "dept:runtime"}
      ],
      "outputs": [
        {"name": "health_status", "type": "signal", "to": "dept:observe"}
      ],
      "rules": [
        {"name": "degraded_threshold", "condition": "mem > 80% or cpu > 90%", "action": "log"}
      ],
      "escalation": {"target": "dept:observe", "threshold": 3, "cascade": ["dept:observe"]},
      "metadata": {
        "crates_owned": ["observability"],
        "files": ["lib/observability.sh"],
        "functions": ["obs_snapshot", "obs_health", "obs_dashboard"]
      }
    },
    {
      "id": "capt:mongodb",
      "name": "MongoDB Store",
      "scale": "captain",
      "parent": "dept:observe",
      "children": [],
      "inputs": [
        {"name": "event_data", "type": "data", "from": "dept:observe"}
      ],
      "outputs": [
        {"name": "stored_doc", "type": "artifact", "to": null}
      ],
      "rules": [
        {"name": "async_only", "condition": "write request", "action": "pass"},
        {"name": "never_block_cli", "condition": "storage failure", "action": "pass"}
      ],
      "escalation": {"target": "dept:observe", "threshold": 4, "cascade": ["dept:observe"]},
      "metadata": {
        "crates_owned": ["mongodb"],
        "files": ["lib/mongodb.sh", "mongodb/store.js", "mongodb/seed-artifacts.js"],
        "collections": ["events", "artifacts", "nodes"]
      }
    },

    {
      "id": "dept:web",
      "name": "Web Dashboard",
      "scale": "department",
      "parent": "root:cage",
      "children": ["capt:flask", "capt:frontend"],
      "inputs": [
        {"name": "http_request", "type": "task", "from": null}
      ],
      "outputs": [
        {"name": "html_page", "type": "artifact", "to": null},
        {"name": "json_response", "type": "data", "to": null}
      ],
      "rules": [
        {"name": "localhost_only", "condition": "always", "action": "pass"}
      ],
      "escalation": {"target": "root:cage", "threshold": 5, "cascade": ["root:cage"]},
      "metadata": {
        "crates_owned": ["web", "dashboard"],
        "files": ["web/app.py", "web/templates/index.html"],
        "port": 5000
      }
    },
    {
      "id": "capt:flask",
      "name": "Flask API",
      "scale": "captain",
      "parent": "dept:web",
      "children": [],
      "inputs": [
        {"name": "api_call", "type": "task", "from": "dept:web"}
      ],
      "outputs": [
        {"name": "json", "type": "data", "to": "dept:web"}
      ],
      "rules": [],
      "escalation": {"target": "dept:web", "threshold": 3, "cascade": ["dept:web"]},
      "metadata": {
        "crates_owned": ["web"],
        "files": ["web/app.py", "web/config_loader.py", "web/session_manager.py", "web/docker_manager.py", "web/workspace_manager.py"],
        "endpoints": ["/api/health", "/api/sessions", "/api/workspaces", "/api/build", "/api/config", "/api/gentlyos/tree"]
      }
    },
    {
      "id": "capt:frontend",
      "name": "Dashboard UI",
      "scale": "captain",
      "parent": "dept:web",
      "children": [],
      "inputs": [
        {"name": "api_data", "type": "data", "from": "capt:flask"}
      ],
      "outputs": [
        {"name": "rendered_view", "type": "artifact", "to": null}
      ],
      "rules": [],
      "escalation": {"target": "dept:web", "threshold": 2, "cascade": ["dept:web"]},
      "metadata": {
        "crates_owned": ["dashboard"],
        "files": ["web/templates/index.html"],
        "views": ["sessions", "workspaces", "build", "config", "gentlyos"]
      }
    },

    {
      "id": "dept:tree",
      "name": "Tree Infrastructure",
      "scale": "department",
      "parent": "root:cage",
      "children": ["capt:tree-ops", "capt:scaffold"],
      "inputs": [
        {"name": "tree_command", "type": "task", "from": "exec:cage"}
      ],
      "outputs": [
        {"name": "tree_json", "type": "artifact", "to": null},
        {"name": "tree_view", "type": "artifact", "to": "root:human"}
      ],
      "rules": [
        {"name": "one_pattern", "condition": "always", "action": "pass"},
        {"name": "schema_valid", "condition": "node missing required fields", "action": "block"}
      ],
      "escalation": {"target": "root:cage", "threshold": 5, "cascade": ["root:cage"]},
      "metadata": {
        "crates_owned": ["tree", "scaffold", "universal-node"],
        "files": ["lib/tree.sh", "universal-node.schema.json", "templates/project/tree.json"],
        "motto": "One pattern. Every scale. Same shape."
      }
    },
    {
      "id": "capt:tree-ops",
      "name": "Tree Operations",
      "scale": "captain",
      "parent": "dept:tree",
      "children": [],
      "inputs": [
        {"name": "tree_path", "type": "data", "from": "dept:tree"},
        {"name": "operation", "type": "task", "from": "dept:tree"}
      ],
      "outputs": [
        {"name": "tree_data", "type": "data", "to": "dept:tree"}
      ],
      "rules": [],
      "escalation": {"target": "dept:tree", "threshold": 3, "cascade": ["dept:tree"]},
      "metadata": {
        "crates_owned": ["tree"],
        "files": ["lib/tree.sh"],
        "functions": ["tree_load", "tree_show", "tree_node", "tree_blast_radius", "tree_route", "tree_add_node", "tree_seed"]
      }
    },
    {
      "id": "capt:scaffold",
      "name": "Project Scaffold",
      "scale": "captain",
      "parent": "dept:tree",
      "children": [],
      "inputs": [
        {"name": "project_params", "type": "task", "from": "dept:tree"}
      ],
      "outputs": [
        {"name": "initialized_project", "type": "artifact", "to": null}
      ],
      "rules": [
        {"name": "no_overwrite", "condition": "tree.json exists", "action": "block"}
      ],
      "escalation": {"target": "dept:tree", "threshold": 2, "cascade": ["dept:tree"]},
      "metadata": {
        "crates_owned": ["scaffold"],
        "files": ["lib/tree.sh", "templates/project/tree.json"],
        "functions": ["tree_init"]
      }
    },

    {
      "id": "dept:ptc",
      "name": "Pass-Through Coordination",
      "scale": "department",
      "parent": "root:cage",
      "children": ["capt:engine", "capt:executor"],
      "inputs": [
        {"name": "intent", "type": "task", "from": "root:cage"},
        {"name": "tree_ref", "type": "data", "from": "dept:tree"}
      ],
      "outputs": [
        {"name": "execution_trace", "type": "artifact", "to": "dept:training"},
        {"name": "aggregated_result", "type": "result", "to": "root:cage"}
      ],
      "rules": [
        {"name": "decompose_first", "condition": "intent received", "action": "pass"},
        {"name": "aggregate_all", "condition": "all leaves complete", "action": "pass"}
      ],
      "escalation": {"target": "root:cage", "threshold": 6, "cascade": ["root:cage"]},
      "metadata": {
        "sephira_mapping": "Tiferet",
        "crates_owned": ["ptc", "engine", "executor"],
        "files": ["ptc/engine.py", "ptc/executor.py"],
        "role": "The machine. Intent flows down. Artifacts flow up."
      }
    },
    {
      "id": "capt:engine",
      "name": "PTC Engine",
      "scale": "captain",
      "parent": "dept:ptc",
      "children": [],
      "inputs": [
        {"name": "intent", "type": "task", "from": "dept:ptc"},
        {"name": "tree", "type": "data", "from": "dept:ptc"}
      ],
      "outputs": [
        {"name": "trace", "type": "artifact", "to": "dept:ptc"}
      ],
      "rules": [
        {"name": "8_phase", "condition": "always", "action": "pass"}
      ],
      "escalation": {"target": "dept:ptc", "threshold": 4, "cascade": ["dept:ptc"]},
      "metadata": {
        "crates_owned": ["engine"],
        "files": ["ptc/engine.py"],
        "functions": ["decompose", "execute_leaf", "aggregate", "run"]
      }
    },
    {
      "id": "capt:executor",
      "name": "Leaf Executor",
      "scale": "captain",
      "parent": "dept:ptc",
      "children": [],
      "inputs": [
        {"name": "task", "type": "task", "from": "capt:engine"}
      ],
      "outputs": [
        {"name": "result", "type": "result", "to": "capt:engine"}
      ],
      "rules": [
        {"name": "safe_commands_only", "condition": "shell mode", "action": "pass"},
        {"name": "never_destructive", "condition": "rm or force", "action": "block"}
      ],
      "escalation": {"target": "dept:ptc", "threshold": 3, "cascade": ["dept:ptc"]},
      "metadata": {
        "crates_owned": ["executor"],
        "files": ["ptc/executor.py"],
        "modes": ["inspect", "shell", "claude", "compose", "plan"]
      }
    },

    {
      "id": "dept:training",
      "name": "Training Pipeline",
      "scale": "department",
      "parent": "root:cage",
      "children": ["capt:extract", "capt:lora"],
      "inputs": [
        {"name": "ptc_traces", "type": "data", "from": "dept:ptc"},
        {"name": "child_traces", "type": "data", "from": null}
      ],
      "outputs": [
        {"name": "training_data", "type": "artifact", "to": null},
        {"name": "lora_adapters", "type": "artifact", "to": "capt:executor"}
      ],
      "rules": [
        {"name": "correct_only", "condition": "failed traces", "action": "transform"},
        {"name": "accumulate", "condition": "threshold reached", "action": "pass"}
      ],
      "escalation": {"target": "root:cage", "threshold": 6, "cascade": ["root:cage"]},
      "metadata": {
        "sephira_mapping": "Yesod",
        "crates_owned": ["training", "extraction", "lora"],
        "files": ["ptc/training.py", "ptc/lora.py"],
        "role": "The Hopf sphere. Build out to feed in. Every trace makes the next run smarter."
      }
    },
    {
      "id": "capt:extract",
      "name": "Training Extractor",
      "scale": "captain",
      "parent": "dept:training",
      "children": [],
      "inputs": [
        {"name": "traces", "type": "data", "from": "dept:training"}
      ],
      "outputs": [
        {"name": "alpaca_data", "type": "artifact", "to": "dept:training"},
        {"name": "cot_data", "type": "artifact", "to": "dept:training"},
        {"name": "sharegpt_data", "type": "artifact", "to": "dept:training"}
      ],
      "rules": [
        {"name": "cot_structure", "condition": "always", "action": "pass"}
      ],
      "escalation": {"target": "dept:training", "threshold": 3, "cascade": ["dept:training"]},
      "metadata": {
        "crates_owned": ["extraction"],
        "files": ["ptc/training.py"],
        "formats": ["alpaca", "sharegpt", "cot"],
        "splits": ["by_node", "by_department", "by_scale"]
      }
    },
    {
      "id": "capt:lora",
      "name": "LoRA Pipeline",
      "scale": "captain",
      "parent": "dept:training",
      "children": [],
      "inputs": [
        {"name": "training_data", "type": "data", "from": "capt:extract"}
      ],
      "outputs": [
        {"name": "adapters", "type": "artifact", "to": "dept:training"}
      ],
      "rules": [
        {"name": "stack_order", "condition": "base before children", "action": "pass"},
        {"name": "qlora", "condition": "always use 4bit quantization", "action": "pass"}
      ],
      "escalation": {"target": "dept:training", "threshold": 4, "cascade": ["dept:training"]},
      "metadata": {
        "crates_owned": ["lora"],
        "files": ["ptc/lora.py"],
        "levels": ["L0:base", "L1:scale", "L2:department", "L3:captain"],
        "hardware": "2x RTX 3090 24GB, QLoRA NF4"
      }
    },

    {
      "id": "dept:architect",
      "name": "Architect System",
      "scale": "department",
      "parent": "root:cage",
      "children": ["capt:blueprints", "capt:ipfs", "capt:vectors", "capt:docs", "capt:federation"],
      "inputs": [
        {"name": "design_intent", "type": "task", "from": "root:cage"},
        {"name": "verification_result", "type": "result", "from": "dept:ptc"}
      ],
      "outputs": [
        {"name": "blueprint", "type": "artifact", "to": "dept:ptc"},
        {"name": "cached_design", "type": "artifact", "to": null},
        {"name": "builder_tasks", "type": "task", "to": "dept:ptc"}
      ],
      "rules": [
        {"name": "cache_first", "condition": "intent matches existing blueprint", "action": "pass"},
        {"name": "design_only", "condition": "no implementation in blueprints", "action": "block"},
        {"name": "embed_all", "condition": "artifact created", "action": "log"}
      ],
      "escalation": {"target": "root:cage", "threshold": 6, "cascade": ["root:cage"]},
      "metadata": {
        "crates_owned": ["architect", "blueprints", "ipfs", "vectors", "design"],
        "sephira_mapping": "Chokmah",
        "files": ["ptc/architect.py", "ptc/ipfs.py", "ptc/embeddings.py", "ptc/git_ops.py"],
        "role": "The brain. Designs hammers, does not pick them up."
      }
    },
    {
      "id": "capt:blueprints",
      "name": "Blueprint Manager",
      "scale": "captain",
      "parent": "dept:architect",
      "children": [],
      "inputs": [
        {"name": "design_intent", "type": "task", "from": "dept:architect"},
        {"name": "cache_query", "type": "data", "from": "dept:architect"}
      ],
      "outputs": [
        {"name": "blueprint", "type": "artifact", "to": "dept:architect"},
        {"name": "builder_tasks", "type": "task", "to": "dept:ptc"}
      ],
      "rules": [
        {"name": "validate_schema", "condition": "blueprint created", "action": "pass"},
        {"name": "require_acceptance", "condition": "no acceptance criteria", "action": "block"}
      ],
      "escalation": {"target": "dept:architect", "threshold": 4, "cascade": ["dept:architect", "root:cage"]},
      "metadata": {
        "crates_owned": ["blueprints"],
        "files": ["ptc/architect.py", "schemas/blueprint.schema.json"],
        "functions": ["create_blueprint", "cache_check", "blueprint_to_tasks", "validate_blueprint", "verify_blueprint"]
      }
    },
    {
      "id": "capt:ipfs",
      "name": "IPFS Storage",
      "scale": "captain",
      "parent": "dept:architect",
      "children": [],
      "inputs": [
        {"name": "artifact", "type": "data", "from": "dept:architect"},
        {"name": "content", "type": "data", "from": null}
      ],
      "outputs": [
        {"name": "cid", "type": "result", "to": "dept:architect"},
        {"name": "hash", "type": "result", "to": null}
      ],
      "rules": [
        {"name": "always_hash", "condition": "any content", "action": "pass"},
        {"name": "ipfs_optional", "condition": "ipfs unavailable", "action": "log"}
      ],
      "escalation": {"target": "dept:architect", "threshold": 3, "cascade": ["dept:architect"]},
      "metadata": {
        "crates_owned": ["ipfs"],
        "files": ["ptc/ipfs.py"],
        "functions": ["content_hash", "ipfs_add", "ipfs_get", "ipfs_pin", "dual_store", "migrate_existing"]
      }
    },
    {
      "id": "capt:vectors",
      "name": "Vector Search",
      "scale": "captain",
      "parent": "dept:architect",
      "children": [],
      "inputs": [
        {"name": "text", "type": "data", "from": "dept:architect"},
        {"name": "query", "type": "task", "from": null}
      ],
      "outputs": [
        {"name": "embedding", "type": "result", "to": "dept:architect"},
        {"name": "search_results", "type": "result", "to": null}
      ],
      "rules": [
        {"name": "model_required", "condition": "no embedding model", "action": "log"},
        {"name": "fallback_text", "condition": "vector search fails", "action": "transform"}
      ],
      "escalation": {"target": "dept:architect", "threshold": 3, "cascade": ["dept:architect"]},
      "metadata": {
        "crates_owned": ["vectors", "embeddings"],
        "files": ["ptc/embeddings.py", "mongodb/vector-setup.js"],
        "functions": ["embed_text", "semantic_search", "embed_trace", "embed_blueprint", "find_similar_traces"]
      }
    },

    {
      "id": "capt:docs",
      "name": "Documentation Circle",
      "scale": "captain",
      "parent": "dept:architect",
      "children": [],
      "inputs": [
        {"name": "tree_nodes", "type": "data", "from": "dept:architect"},
        {"name": "file_changes", "type": "signal", "from": null}
      ],
      "outputs": [
        {"name": "doc_artifacts", "type": "artifact", "to": "dept:architect"},
        {"name": "interconnection_graph", "type": "artifact", "to": null},
        {"name": "staleness_report", "type": "signal", "to": "dept:architect"}
      ],
      "rules": [
        {"name": "hash_track", "condition": "file modified", "action": "log"},
        {"name": "propagate_stale", "condition": "doc marked stale", "action": "pass"},
        {"name": "bidirectional", "condition": "edge created", "action": "pass"}
      ],
      "escalation": {"target": "dept:architect", "threshold": 3, "cascade": ["dept:architect"]},
      "metadata": {
        "crates_owned": ["docs", "circle"],
        "files": ["ptc/docs.py", "lib/docs.sh"],
        "functions": ["generate_doc", "generate_all", "full_interconnect", "check_staleness", "propagate_staleness", "search_docs"],
        "role": "The circle. Documentation as code. Change one side, the other knows."
      }
    },

    {
      "id": "capt:federation",
      "name": "Git Federation",
      "scale": "captain",
      "parent": "dept:architect",
      "children": [],
      "inputs": [
        {"name": "upstream_url", "type": "config", "from": "dept:architect"},
        {"name": "sync_request", "type": "task", "from": "dept:architect"}
      ],
      "outputs": [
        {"name": "federation_manifest", "type": "artifact", "to": "dept:architect"},
        {"name": "sync_result", "type": "result", "to": "dept:architect"}
      ],
      "rules": [
        {"name": "fork_sovereign", "condition": "always", "action": "pass"},
        {"name": "tree_integrity", "condition": "merge breaks refs", "action": "block"},
        {"name": "trust_verify", "condition": "hash mismatch", "action": "escalate"}
      ],
      "escalation": {"target": "dept:architect", "threshold": 5, "cascade": ["dept:architect", "root:cage"]},
      "metadata": {
        "crates_owned": ["federation", "sovereignty"],
        "files": ["ptc/federation.py"],
        "functions": ["init_fork", "sync_pull", "sync_push", "diff_trees", "merge_trees", "verify_trust"],
        "role": "Git sovereignty. Bidirectional forking where the fork decides. Always."
      }
    },

    {
      "id": "dept:integrations",
      "name": "External Integrations",
      "scale": "department",
      "parent": "root:cage",
      "children": ["capt:porkbun", "capt:nounproject", "capt:huggingface"],
      "inputs": [
        {"name": "integration_request", "type": "task", "from": "root:cage"}
      ],
      "outputs": [
        {"name": "api_result", "type": "result", "to": "root:cage"},
        {"name": "asset", "type": "artifact", "to": null}
      ],
      "rules": [
        {"name": "env_required", "condition": "credentials missing", "action": "log"},
        {"name": "graceful_degrade", "condition": "service unavailable", "action": "pass"}
      ],
      "escalation": {"target": "root:cage", "threshold": 5, "cascade": ["root:cage"]},
      "metadata": {
        "crates_owned": ["integrations", "domains", "icons", "ml-hub"],
        "files": ["lib/integrations.sh", "ptc/porkbun.py", "ptc/nounproject.py", "ptc/huggingface.py"],
        "role": "External service integrations. Domains, design assets, ML models."
      }
    },
    {
      "id": "capt:porkbun",
      "name": "Porkbun Domains",
      "scale": "captain",
      "parent": "dept:integrations",
      "children": [],
      "inputs": [
        {"name": "domain_request", "type": "task", "from": "dept:integrations"}
      ],
      "outputs": [
        {"name": "domain_result", "type": "result", "to": "dept:integrations"}
      ],
      "rules": [
        {"name": "auth_required", "condition": "no api key", "action": "block"}
      ],
      "escalation": {"target": "dept:integrations", "threshold": 3, "cascade": ["dept:integrations"]},
      "metadata": {
        "crates_owned": ["domains", "dns", "ssl"],
        "files": ["ptc/porkbun.py"],
        "functions": ["ping", "check_domain", "list_domains", "get_dns", "create_dns", "get_ssl"],
        "api": "Porkbun API v3"
      }
    },
    {
      "id": "capt:nounproject",
      "name": "Noun Project Icons",
      "scale": "captain",
      "parent": "dept:integrations",
      "children": [],
      "inputs": [
        {"name": "icon_request", "type": "task", "from": "dept:integrations"}
      ],
      "outputs": [
        {"name": "icon_data", "type": "artifact", "to": "dept:integrations"}
      ],
      "rules": [
        {"name": "oauth_required", "condition": "no credentials", "action": "block"}
      ],
      "escalation": {"target": "dept:integrations", "threshold": 3, "cascade": ["dept:integrations"]},
      "metadata": {
        "crates_owned": ["icons", "design-assets"],
        "files": ["ptc/nounproject.py"],
        "functions": ["search_icons", "get_icon", "download_icon", "batch_download", "save_icon"],
        "api": "Noun Project API v2, OAuth 1.0a"
      }
    },
    {
      "id": "capt:huggingface",
      "name": "Hugging Face Hub",
      "scale": "captain",
      "parent": "dept:integrations",
      "children": [],
      "inputs": [
        {"name": "ml_request", "type": "task", "from": "dept:integrations"}
      ],
      "outputs": [
        {"name": "model_data", "type": "artifact", "to": "dept:integrations"},
        {"name": "embedding", "type": "data", "to": "capt:vectors"}
      ],
      "rules": [
        {"name": "token_required", "condition": "no HF_TOKEN", "action": "block"},
        {"name": "cache_aware", "condition": "model cached", "action": "pass"}
      ],
      "escalation": {"target": "dept:integrations", "threshold": 4, "cascade": ["dept:integrations"]},
      "metadata": {
        "crates_owned": ["huggingface", "ml-hub", "inference"],
        "files": ["ptc/huggingface.py"],
        "functions": ["hf_init", "download_model", "embed_text", "chat", "list_models", "upload_folder", "cache_status"],
        "dependency": "huggingface_hub>=1.0.0"
      }
    },

    {
      "id": "project:gentlyos",
      "name": "GentlyOS",
      "scale": "department",
      "parent": "root:cage",
      "children": [],
      "inputs": [
        {"name": "intent", "type": "task", "from": "root:cage"}
      ],
      "outputs": [
        {"name": "traces", "type": "artifact", "to": "dept:training"},
        {"name": "artifacts", "type": "artifact", "to": "dept:observe"}
      ],
      "rules": [
        {"name": "own_tree", "condition": "has gentlyos/tree.json", "action": "pass"},
        {"name": "feed_root", "condition": "trace generated", "action": "pass"}
      ],
      "escalation": {"target": "root:cage", "threshold": 5, "cascade": ["root:cage"]},
      "metadata": {
        "crates_owned": ["gentlyos"],
        "tree_path": "gentlyos/tree.json",
        "node_count": 35,
        "files": ["gentlyos/tree.json", "gentlyos/seed.js"],
        "role": "Child project tree. 34 agents. Sephirot mapping. Its own PTC cycle. Traces flow back to root."
      }
    }
  ],
  "projects": {
    "description": "Child project registry. Every claude-cage init adds here. Every child tree's traces flow back to root.",
    "registered": [
      {
        "id": "project:gentlyos",
        "name": "GentlyOS",
        "tree_path": "gentlyos/tree.json",
        "node_count": 35,
        "status": "active"
      }
    ]
  },
  "coordination": {
    "phases": ["INTAKE", "TRIAGE", "PLAN", "REVIEW", "EXECUTE", "VERIFY", "INTEGRATE", "SHIP"],
    "approval_cascade": {
      "low_1_3": "captain approves",
      "medium_4_6": "department approves",
      "high_7_8": "executive approves",
      "critical_9_10": "human final call"
    }
  },
  "sephirot_mapping": {
    "Keter": "root:cage",
    "Daath": "dept:security",
    "Tiferet": "dept:ptc",
    "Yesod": "dept:training",
    "Malkuth": "dept:runtime",
    "Netzach": "dept:sessions",
    "Hod": "dept:config",
    "Chesed": "dept:tree",
    "Gevurah": "dept:observe",
    "Chokmah": "dept:web"
  }
}
