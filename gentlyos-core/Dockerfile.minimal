# GentlyOS Minimal Image
# Smallest possible runtime - for embedded/IoT/edge deployment

# Build stage
FROM rust:1.75-alpine AS builder

WORKDIR /app

# Install build dependencies
RUN apk add --no-cache \
    musl-dev \
    openssl-dev \
    openssl-libs-static \
    pkgconfig

# Copy source
COPY Cargo.toml Cargo.lock ./
COPY crates ./crates
COPY gently-cli ./gently-cli

# Build static binary
ENV RUSTFLAGS="-C target-feature=+crt-static"
RUN cargo build --release --target x86_64-unknown-linux-musl -p gently-cli

# Runtime stage - scratch (empty base)
FROM scratch

# Copy CA certificates for HTTPS
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/

# Copy static binary
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/gently /gently

# Create minimal filesystem structure
COPY --from=builder /tmp /tmp

# Environment
ENV GENTLY_DATA_DIR=/data
ENV RUST_LOG=info

# Data volume
VOLUME ["/data"]

# Health check port
EXPOSE 8080

ENTRYPOINT ["/gently"]
CMD ["--help"]
